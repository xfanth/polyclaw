# =============================================================================
# Smoke Test Configuration for OpenClaw/PicoClaw Docker
# =============================================================================
# Usage:
#   UPSTREAM=openclaw docker compose -f docker-compose.test.yml up -d
#   UPSTREAM=picoclaw docker compose -f docker-compose.test.yml up -d
# =============================================================================

services:
  gateway-test:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UPSTREAM: ${UPSTREAM:-openclaw}
        UPSTREAM_VERSION: ${UPSTREAM_VERSION:-main}
    image: ${UPSTREAM:-openclaw}:smoke-test
    container_name: ${UPSTREAM:-openclaw}-smoke-test
    environment:
      - UPSTREAM=${UPSTREAM:-openclaw}
      - OPENCLAW_GATEWAY_TOKEN=test-token-smoke-test
      - OPENROUTER_API_KEY=sk-or-test-key
      - AUTH_PASSWORD=testpass
      - AUTH_USERNAME=admin
      - BROWSER_CDP_URL=http://browser:9222
      - OPENCLAW_PRIMARY_MODEL=openrouter/anthropic/claude-sonnet-4-5
    ports:
      - "18080:8080"
    volumes:
      - type: bind
        source: ./test-data
        target: /data/.${UPSTREAM:-openclaw}
      - type: bind
        source: ./test-workspace
        target: /data/workspace
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - AUDIT_WRITE
      - DAC_READ_SEARCH
      - NET_BIND_SERVICE
      - KILL
    networks:
      - test-network
    depends_on:
      browser:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 5s
      timeout: 3s
      start_period: 30s
      retries: 10

  browser:
    image: ghcr.io/n00b001/cdp_vnc_browser:latest
    container_name: gateway-browser-test
    environment:
      - PUID=1000
      - PGID=1000
      - CHROME_CLI=--remote-debugging-port=9222 --no-sandbox --disable-dev-shm-usage
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9222/json/version"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 5

networks:
  test-network:
    driver: bridge
