# =============================================================================
# Smoke Test Workflow
# =============================================================================
# Runs smoke tests on every PR and push to main
# =============================================================================

name: Smoke Test

on:
  pull_request:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'Dockerfile.*'
      - 'scripts/**'
      - 'nginx.conf'
      - 'docker-compose*.yml'
      - '.github/workflows/smoke-test.yml'
  
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'Dockerfile.*'
      - 'scripts/**'
      - 'nginx.conf'
      - 'docker-compose*.yml'
      - '.github/workflows/smoke-test.yml'
  
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # -----------------------------------------------------------------------
      # Set up Docker Buildx
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # -----------------------------------------------------------------------
      # Free up disk space
      # -----------------------------------------------------------------------
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af
      
      # -----------------------------------------------------------------------
      # Run smoke test
      # -----------------------------------------------------------------------
      - name: Run smoke test
        run: |
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh
        timeout-minutes: 15
      
      # -----------------------------------------------------------------------
      # Upload logs on failure
      # -----------------------------------------------------------------------
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            /tmp/build.log
            /tmp/compose.log
            /tmp/doctor.log
          retention-days: 3
      
      # -----------------------------------------------------------------------
      # Cleanup
      # -----------------------------------------------------------------------
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v --remove-orphans 2>/dev/null || true
          docker system prune -af
